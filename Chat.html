<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-section, .chat-section {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #ccc;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="login-section">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <div id="loginStatus"></div>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="chat-section hidden">
            <h2>Chat Room</h2>
            <div>
                <input type="text" id="roomId" placeholder="Room ID">
                <button onclick="joinRoom()">Join Room</button>
                <button onclick="leaveRoom()">Leave Room</button>
            </div>
            <div id="currentRoom"></div>
            <div id="messages" class="messages"></div>
            <div>
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        let currentToken = '';
        let currentRoomId = '';
        const socket = io('http://localhost:4000', {
            transports: ['websocket'],
            autoConnect: true
        });

        // GraphQL endpoint
        const GRAPHQL_ENDPOINT = 'http://localhost:4000/graphql';

        // GraphQL request function
        async function graphqlRequest(query, variables = {}, token = null) {
            const headers = {
                'Content-Type': 'application/json',
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(GRAPHQL_ENDPOINT, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    query: query,
                    variables: variables
                })
            });

            return response.json();
        }

        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const loginMutation = `
                mutation Login($username: String!, $password: String!) {
                    login(username: $username, password: $password)
                }
            `;

            try {
                const result = await graphqlRequest(loginMutation, { username, password });
                if (result.data?.login) {
                    currentToken = result.data.login;  
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('chatSection').classList.remove('hidden');
                    document.getElementById('loginStatus').textContent = 'Logged in successfully!';
                } else {
                    document.getElementById('loginStatus').textContent = 'Login failed: ' + 
                        (result.errors?.[0]?.message || 'Unknown error');
                }
            } catch (error) {
                document.getElementById('loginStatus').textContent = 'Login error: ' + error.message;
            }
        }

        // Join room function
        async function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            
            const joinRoomMutation = `
                mutation JoinRoom($roomId: ID!) {
                    joinRoom(roomId: $roomId) {
                        id
                        name
                        participants {
                            username
                        }
                    }
                }
            `;

            try {
                const result = await graphqlRequest(joinRoomMutation, { roomId }, currentToken);
                if (result.data?.joinRoom) {
                    currentRoomId = roomId;
                    socket.emit('joinRoom', roomId);
                    document.getElementById('currentRoom').textContent = `Current Room: ${roomId}`;
                    updateParticipantsList(result.data.joinRoom.participants);
                }
            } catch (error) {
                console.error('Error joining room:', error);
            }
        }

        // Leave room function
        async function leaveRoom() {
            if (!currentRoomId) return;

            const leaveRoomMutation = `
                mutation LeaveRoom($roomId: ID!) {
                    leaveRoom(roomId: $roomId)
                }
            `;

            try {
                await graphqlRequest(leaveRoomMutation, { roomId: currentRoomId }, currentToken);
                socket.emit('leaveRoom', currentRoomId);
                currentRoomId = '';
                document.getElementById('currentRoom').textContent = '';
                document.getElementById('messages').innerHTML = '';
            } catch (error) {
                console.error('Error leaving room:', error);
            }
        }

        // Send message function
        async function sendMessage() {
            if (!currentRoomId) return;
            
            const content = document.getElementById('messageInput').value;
            if (!content.trim()) return;

            const sendMessageMutation = `
                mutation SendMessage($roomId: ID!, $content: String!) {
                    sendMessage(roomId: $roomId, content: $content) {
                        id
                        content
                        sender {
                            username
                        }
                    }
                }
            `;

            try {
                await graphqlRequest(sendMessageMutation, 
                    { roomId: currentRoomId, content }, 
                    currentToken
                );
                document.getElementById('messageInput').value = '';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Socket event handlers
        socket.on('connect', () => {
            console.log('Connected to socket server');
        });

        socket.on('newMessage', (message) => {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `<strong>${message.sender.username}:</strong> ${message.content}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Handle enter key in message input
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        socket.on('userJoined', async (data) => {
            if (currentRoomId === data.roomId) {
                // Add notification message
                const messagesDiv = document.getElementById('messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.style.color = 'green';  // Make join messages green
                messageElement.innerHTML = `<em>A new user has joined the room</em>`;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                // Fetch updated room info
                const roomQuery = `
                    query GetRoom($roomId: ID!) {
                        room(id: $roomId) {
                            participants {
                                username
                            }
                        }
                    }
                `;
                
                try {
                    const result = await graphqlRequest(roomQuery, { roomId: currentRoomId }, currentToken);
                    if (result.data?.room) {
                        updateParticipantsList(result.data.room.participants);
                    }
                } catch (error) {
                    console.error('Error fetching updated participants:', error);
                }
            }
        });

        socket.on('userLeft', async (data) => {
            if (currentRoomId === data.roomId) {
                // Add notification message
                const messagesDiv = document.getElementById('messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.style.color = 'red';  // Make leave messages red
                messageElement.innerHTML = `<em>A user has left the room</em>`;
                messagesDiv.appendChild(messageElement);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

                // Fetch updated room info
                const roomQuery = `
                    query GetRoom($roomId: ID!) {
                        room(id: $roomId) {
                            participants {
                                username
                            }
                        }
                    }
                `;
                
                try {
                    const result = await graphqlRequest(roomQuery, { roomId: currentRoomId }, currentToken);
                    if (result.data?.room) {
                        updateParticipantsList(result.data.room.participants);
                    }
                } catch (error) {
                    console.error('Error fetching updated participants:', error);
                }
            }
        });

        // Update the updateParticipantsList function to clear previous list
        function updateParticipantsList(participants) {
            const participantsList = participants.map(p => p.username).join(', ');
            const currentRoomDiv = document.getElementById('currentRoom');
            // Keep only the room ID line and update participants
            currentRoomDiv.innerHTML = `Current Room: ${currentRoomId}<br>Participants: ${participantsList}`;
        }
    </script>
</body>
</html>